+++
title = "Decode UTF-8"
summary = ""
description = ""
categories = [""]
tags = []
date = 2025-08-19T00:17:33+09:00
draft = false
+++

å­¦ä¹ ä¸€ç‚¹å¤è€æŠ€æ³• https://bjoern.hoehrmann.de/utf-8/decoder/dfa/



è¯¥æŠ€æ³•è¢«ä¸‹é¢é¡¹ç›®ä½¿ç”¨:
- https://github.com/oven-sh/bun/blob/29068c2118b272a2eec97b66b43269e6c3dd4456/src/string/immutable/unicode.zig#L1469
- https://github.com/nlohmann/json/blob/52d3f6e034504b4097741b2da5b644a38ee273ff/include/nlohmann/detail/output/serializer.hpp#L898


å·²çŸ¥å¯èƒ½å­˜åœ¨çš„é—®é¢˜:
- https://git.sr.ht/~slink/hoehrmann-utf8
- https://github.com/hoehrmann/utf-8-misc/issues/1 è¿™ä¸ªé—®é¢˜åœ¨ 2010 ç‰ˆæœ¬ä»£ç  decode çš„æ—¶å€™æˆ‘æ²¡æœ‰å¤ç°



## å‰ç½®çŸ¥è¯†

- UTF-8 ä½¿ç”¨ 1 åˆ° 4 ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ª Unicode å­—ç¬¦ã€‚åœ¨æœ€åˆçš„ UTF-8 è®¾è®¡é‡Œæ˜¯è¯´å¯ä»¥ 5 åˆ° 6 ä¸ªå­—èŠ‚çš„ï¼Œä½†æ˜¯ç›®å‰æ²¡æœ‰å®é™…ç”¨é€”ï¼Œå› ä¸º Unicode çš„èŒƒå›´æ˜¯ U+0000 ~ U+10FFFF (å…± 1114112 ä¸ª codepoint)

- ASCII èŒƒå›´çš„å­—ç¬¦ (U+0000 ~ U+007F) ç”¨ 1 ä¸ªå­—èŠ‚ï¼Œå…¼å®¹æ—©æœŸçš„ ASCIIã€‚å…¶ä»–å­—ç¬¦ä½¿ç”¨ 2~4 ä¸ªå­—èŠ‚

- å­—èŠ‚æ¨¡å¼æœ‰è§„å¾‹
   æ¯ä¸ªå­—èŠ‚éƒ½æœ‰ç‰¹å®šçš„å‰ç¼€ï¼Œèƒ½åˆ¤æ–­è¿™æ˜¯å¤šå­—èŠ‚åºåˆ—ä¸­çš„ç¬¬å‡ ä¸ªå­—èŠ‚ï¼š

  - å•å­—èŠ‚ (ASCII): `0xxxxxxx`
    - å¤šå­—èŠ‚èµ·å§‹å­—èŠ‚ï¼š
      - 2 å­—èŠ‚: `110xxxxx`
      - 3 å­—èŠ‚: `1110xxxx`
      - 4 å­—èŠ‚: `11110xxx`

  - åç»­å­—èŠ‚ (Continuation byte): `10xxxxxx`

- è‡ªåŒæ­¥ (Self-synchronizing) 

  - UTF-8 ä»»æ„ä½ç½®å‘å‰/å‘åæ‰«ææ—¶ï¼Œéƒ½èƒ½å¿«é€Ÿå®šä½ä¸‹ä¸€ä¸ªå­—ç¬¦çš„è¾¹ç•Œã€‚

  - è¿™æ˜¯å› ä¸º continuation byte ä¸€å®šä»¥ `10` å¼€å¤´ï¼Œè€Œèµ·å§‹å­—èŠ‚ä¸ä¼šã€‚

- ä¸ä¼šå‡ºç° `0x00`  (é™¤äº†ç©ºå­—ç¬¦æœ¬èº«) 

  - åœ¨é ASCII æƒ…å†µä¸‹ï¼ŒUTF-8 ä¸ä¼šäº§ç”Ÿé¢å¤–çš„ `0x00`ï¼Œå¯¹ C è¯­è¨€ç­‰ä¾èµ– `\0` ç»“å°¾çš„ç³»ç»Ÿå‹å¥½ã€‚


| Unicode ç ç‚¹èŒƒå›´   | UTF-8 å­—èŠ‚åºåˆ—                      |
| ------------------ | ----------------------------------- |
| U+0000 ~ U+007F    | 0xxxxxxx                            |
| U+0080 ~ U+07FF    | 110xxxxx 10xxxxxx                   |
| U+0800 ~ U+FFFF    | 1110xxxx 10xxxxxx 10xxxxxx          |
| U+10000 ~ U+10FFFF | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx |



## å®ç°

æ ¸å¿ƒæ€è·¯æ˜¯è¡¨é©±åŠ¨ DFA:

- å°†æ¯ä¸ªè¾“å…¥å­—èŠ‚å…ˆæ˜ å°„åˆ°ä¸€ä¸ªå°æ•´æ•°ç±»å‹
- ä½¿ç”¨ "çŠ¶æ€ + ç±»å‹ -> ä¸‹ä¸€çŠ¶æ€" çš„è½¬ç§»è¡¨æ¨è¿›è§£æä¸åˆæ³•æ€§åˆ¤æ–­
- åœ¨æ¨è¿›è¿‡ç¨‹ä¸­ç”¨ç»Ÿä¸€çš„ä½è¿ç®—ç´¯ç§¯ç ç‚¹

ä¼˜ç‚¹æ˜¯:
- èŒƒå›´åˆ¤æ–­è¢«é¢„å…ˆæ¯”ç¼–ç è¿›è¡¨ï¼›è¿è¡Œæ—¶åªåšä¸¤æ¬¡æ•°ç»„è®¿é—®ä¸å°‘é‡ä½è¿ç®—
- åˆ†æ”¯æå°‘ï¼Œå¯¹ CPU é¢„æµ‹ä¸æµæ°´çº¿æ›´å‹å¥½
- æ•°æ®å±€éƒ¨æ€§å¥½ï¼š`utf8d` å¾ˆå°ï¼Œå®¹æ˜“å‘½ä¸­ CacheLine



### 1. å­—èŠ‚->ç±»å‹æ˜ å°„

Hoehrmann çš„åšæ³•æ˜¯:
- å…ˆå¯¹æ‰€æœ‰ 0x00..0xFF çš„å­—èŠ‚åšä¸€æ¬¡åˆ†ç±»ï¼Œæ˜ å°„æˆä¸€ä¸ªå°æ•´æ•°ç±»å‹
- è¿™äº›ç±»å‹æ˜¯æŒ‰ UTF-8 çš„è¯­ä¹‰åˆ’åˆ†çš„: ä¾‹å¦‚ ASCII æ˜¯ä¸€ç±»ï¼›åç»­å­—èŠ‚ (10xxxxxx) å†ç»†åˆ†ä¸ºå‡ ç±»ï¼›E0/ED/F0/F4 è¿™ç§åç»­å—é™çš„èµ·å§‹å­—èŠ‚è¢«åˆ†é…åˆ°ç‹¬ç«‹çš„ç±»å‹ï¼›C0/C1ã€F5..FF å½’å…¥éæ³•èµ·å§‹ç±»

è¿™æ ·åšçš„å¥½å¤„:
- è¿è¡Œæ—¶ä¸å†å¯¹å­—èŠ‚æœ¬èº«åšå¤æ‚æ¯”è¾ƒï¼Œåªéœ€ä¸€æ¬¡è¡¨æŸ¥æ‰¾å°±å¾—åˆ°ç±»å‹
- åç»­çš„åˆæ³•æ€§åˆ¤æ–­é€šé€šåŒ–ä¸º "çŠ¶æ€ + ç±»å‹ -> ä¸‹ä¸€çŠ¶æ€" çš„æŸ¥è¡¨é—®é¢˜



![](./dfa-bytes.png)



æ¯”å¦‚:
- 00..7F -> 0 (ASCII) 
- 80..8F -> 1ï¼Œ90..9F -> 9ï¼ŒA0..BF -> 7 (ç»­å­—èŠ‚æŒ‰èŒƒå›´ç»†åˆ†) 
- C2..DF -> 2 (2 å­—èŠ‚èµ·å§‹) 
- E0 -> 10ï¼›E1..ECã€EE..EF -> 3ï¼›ED -> 4 (3 å­—èŠ‚èµ·å§‹ï¼ŒE0/ED ç‰¹åŒ–) 
- F0 -> 11ï¼›F1..F3 -> 6ï¼›F4 -> 5 (4 å­—èŠ‚èµ·å§‹ï¼ŒF0/F4 ç‰¹åŒ–) 
- C0/C1ã€F5..FF -> 8 (éæ³•èµ·å§‹) 





è¿™äº›ç±»å‹å…¶å®åˆšå¥½æŠŠ UTF-8 çš„éœ€è¦ç‰¹åˆ«åˆ¤æ–­çš„ç‚¹å•ç‹¬æŠ½å‡ºæ¥äº†ï¼š

- E0 çš„ç¬¬äºŒä¸ªå­—èŠ‚å¿…é¡»æ˜¯ A0..BF (é¿å…è¿‡é•¿) ï¼Œå› æ­¤ E0 æ‹¿åˆ°â€œ10â€ç±»å‹ï¼Œåœ¨çŠ¶æ€è¡¨ä¸­å¯ä»¥è®©â€œä¸ 1 å’Œ 9 ç±»ç»­å­—èŠ‚çš„ç»„åˆâ€ç›´æ¥è¿›å…¥æ‹’ç»ï¼Œä¿ç•™ä¸ 7 ç±»çš„ç»„åˆï¼›
- ED ç”¨äºå±è”½ä»£ç†åŒºé—´ D800..DFFFï¼Œå¯¹åº”ç¬¬äºŒä¸ªå­—èŠ‚å¿…é¡»æ˜¯ 80..9Fï¼Œå› æ­¤ ED æ‹¿åˆ°â€œ4â€ç±»å‹ï¼›
- F0 çš„ç¬¬äºŒä¸ªå­—èŠ‚å¿…é¡»æ˜¯ 90..BF (é¿å…è¿‡é•¿) ï¼Œæ‰€ä»¥ F0 æ‹¿åˆ°â€œ11â€ç±»å‹ï¼›
- F4 çš„ç¬¬äºŒä¸ªå­—èŠ‚å¿…é¡»æ˜¯ 80..8F (ä¸è¶…è¿‡ U+10FFFF) ï¼Œæ‰€ä»¥ F4 æ‹¿åˆ°â€œ5â€ç±»å‹ã€‚



### 2. ç”¨"çŠ¶æ€ + ç±»å‹"æŸ¥è¡¨æ¥æ¨è¿›è§£æä¸åˆæ³•æ€§æ£€æŸ¥



![](./dfa-classes.png)

æœ‰äº†ç±»å‹ï¼Œä¸‹ä¸€æ­¥æ˜¯æŠŠæˆ‘ä»¬ç°åœ¨åœ¨å¤šå­—èŠ‚ç¼–ç çš„å“ªä¸ªé˜¶æ®µæŠ½è±¡æˆçŠ¶æ€

- å½“è¯»åˆ°èµ·å§‹å­—èŠ‚ (é ASCII) åï¼Œæˆ‘ä»¬æœŸå¾…è‹¥å¹²ä¸ªç»­å­—èŠ‚
- æ¯è¯»åˆ°ä¸€ä¸ªåˆè§„ç»­å­—èŠ‚ï¼ŒæœŸå¾…çš„æ•°é‡å‡ä¸€ã€‚å‡åˆ° 0 åˆ™ç»„è£…å‡ºå®Œæ•´ç ç‚¹ (ACCEPT)
- å¦‚æœæŸä¸€æ­¥è¯»åˆ°çš„ç±»å‹ä¸åœ¨å½“å‰çŠ¶æ€å…è®¸çš„é›†åˆä¸­ï¼Œå°±è¿›å…¥ REJECT
- æœ‰äº›èµ·å§‹å­—èŠ‚ (E0/ED/F0/F4) ä¼šé€‰æ‹©ä¸åŒçš„åç»­å­—èŠ‚å­ç±»


### 3. åŒæ—¶ç”¨ä½è¿ç®—ç´¯ç§¯ç ç‚¹



åˆæ³•æ€§ä»…é çŠ¶æ€è½¬ç§»å¯åˆ¤æ–­ï¼Œä½†æˆ‘ä»¬è¿˜è¦æ¢å¤ç ç‚¹çš„æ•°å€¼ã€‚
- è‹¥åœ¨ç»­å­—èŠ‚é˜¶æ®µï¼š`codep = (codep << 6) | (byte & 0x3F)` (æŠŠ 6 ä½æœ‰æ•ˆè´Ÿè½½æ‹¼åˆ°ç ç‚¹æœ«å°¾) 
- è‹¥åœ¨èµ·å§‹å­—èŠ‚é˜¶æ®µï¼š`codep = (0xFF >> type) & byte` (ç”¨ç±»å‹å†³å®šæ©ç ï¼šèµ·å§‹ 1/2/3/4 å­—èŠ‚åˆ†åˆ«å¯¹åº” 0x7F/0x1F/0x0F/0x07) 


æ–‡ç« ä¸­æåˆ°äº†ä¸¤ä¸ªç‰ˆæœ¬

- æœ€åˆç‰ˆï¼š`UTF8_ACCEPT=0`ï¼Œ`UTF8_REJECT=1`ï¼Œç´¢å¼• `256 + state*16 + type`
- 2010 æ”¹è¿›ç‰ˆæœ¬ï¼š`UTF8_ACCEPT=0`ï¼Œ`UTF8_REJECT=12`ï¼ŒçŠ¶æ€å€¼åœ¨è½¬ç§»è¡¨ä¸­å·²ç»é¢„ä¹˜äº† 16ï¼Œå› æ­¤ç´¢å¼•è®¡ç®—ç®€åŒ–ä¸º `256 + state + type`



æ ¸å¿ƒçŠ¶æ€è½¬ç§»ä»£ç 

```c
// å– 2010 ç‰ˆæœ¬
uint32_t decode(uint32_t* state, uint32_t* codep, uint32_t byte) {
  uint32_t type = utf8d[byte];                 // 1) æŸ¥å­—èŠ‚ç±»å‹
  *codep = (*state != UTF8_ACCEPT)             // 2) æ— åˆ†æ”¯ç´¯ç§¯ç ç‚¹
    ? (byte & 0x3Fu) | (*codep << 6)
    : (0xFFu >> type) & byte;
  *state = utf8d[256 + *state + type];         // 3) æŸ¥è¡¨æ¨è¿›çŠ¶æ€ (çŠ¶æ€å·²é¢„ä¹˜16) 
  return *state;                               // 4) è¿”å›æ–°çŠ¶æ€
}
```

å°† `state`/`codep` æŒä¹…åŒ–åœ¨è°ƒç”¨æ–¹ï¼Œå®ç°æµå¼çš„è§£ç 

- `UTF8_ACCEPT`: è¯»å®Œä¸€ä¸ªå®Œæ•´ç ç‚¹æˆ–å¤„äºèµ·å§‹ä½ç½®
- `UTF8_REJECT`: éæ³•è·¯å¾„
- å…¶å®ƒæ­£å€¼: å¤„äº"æœŸå¾… n ä¸ªåç»­å­—èŠ‚"çš„ä¸­é—´çŠ¶æ€



### é˜²è¿‡é•¿ (overlong) 

- 2 å­—èŠ‚æœ€å°ç ç‚¹æ˜¯ U+0080 (`11000010 10000000` å³ C2 80) ã€‚å› æ­¤ï¼š
  - C0/C1 ä½œä¸ºèµ·å§‹éƒ½éæ³• (å·²åœ¨â€œå­—èŠ‚->ç±»å‹â€æ˜ å°„ä¸­åˆ†åˆ°éæ³•ç±») 
  - å¯¹ 3 å­—èŠ‚èµ·å§‹ E0ï¼šç¬¬äºŒä¸ªå­—èŠ‚å¿…é¡»æ˜¯ A0..BF (ç±» 7) ï¼Œå¦åˆ™ E0 80..9F ä¼šå½¢æˆ 2 å­—èŠ‚å¯è¡¨è¾¾çš„å€¼çš„è¿‡é•¿å˜ä½“ã€‚
  - å¯¹ 4 å­—èŠ‚èµ·å§‹ F0ï¼šç¬¬äºŒä¸ªå­—èŠ‚å¿…é¡»æ˜¯ 90..BF (ç±» 9) ï¼Œå¦åˆ™ F0 80..8F ä¼šå½¢æˆ 3 å­—èŠ‚å¯è¡¨è¾¾çš„å€¼çš„è¿‡é•¿å˜ä½“ã€‚

è¡¨ä¸­æ­£æ˜¯é€šè¿‡ç»™ E0/F0 å•ç‹¬ç±»å‹ (10/11) ï¼Œå¹¶è®©ä¸ä¸åˆè¦æ±‚çš„ç»­å­—èŠ‚ç±»å‹ç»„åˆçš„è½¬ç§»æŒ‡å‘ `REJECT` æ¥å®ç°çš„ã€‚



### ç¦ä»£ç†åŒºé—´ (surrogate) 

- ä»£ç†åŒº U+D800..U+DFFF åœ¨ UTF-8 ä¸­éæ³•ã€‚å…¶ 3 å­—èŠ‚ç¼–ç è½ç‚¹æ°å¥½æ˜¯ `ED A0..ED BF`ã€‚
- å› æ­¤ ED è¢«åˆ†åˆ°ç‰¹åŒ–ç±»å‹ 4ï¼Œä½¿ "ED -> ç¬¬äºŒå­—èŠ‚=ç±» 7 (A0..BF) " çš„ç»„åˆè¿›å…¥ `REJECT`ï¼Œè€Œ "ED -> ç¬¬äºŒå­—èŠ‚=ç±» 1 (80..8F) æˆ– 9 (90..9F)" ä¿æŒç»§ç»­ï¼Œä»è€Œé¿å¼€ D800..DFFFã€‚



### æ§ä¸Šç•Œ (â‰¤ U+10FFFF) 

- 4 å­—èŠ‚ç¼–ç ä¸Šç•Œæ˜¯ F4 8F BF BF (U+10FFFF) ã€‚
- å› æ­¤ F4 è¢«åˆ†åˆ°ç‰¹åŒ–ç±»å‹ 5ï¼Œä½¿ "F4 -> ç¬¬äºŒå­—èŠ‚=ç±» 1 (80..8F) " åˆæ³•ï¼›è‹¥ç¬¬äºŒå­—èŠ‚åˆ° 90..BF (ç±» 9) ï¼Œåˆ™è½¬ç§» `REJECT`ã€‚



## ç¤ºä¾‹

###  ä¾‹å­ 1ï¼š`E4 B8 96` (â€œä¸–â€ U+4E16) 

æ­¥éª¤ï¼š
1) è¯» `0xE4`ï¼šç±»å‹ä¸º 3 (3 å­—èŠ‚èµ·å§‹çš„å¸¸è§„ç±») ã€‚
   - çŠ¶æ€ï¼šä» `ACCEPT` (èµ·å§‹) è½¬åˆ°â€œæœŸå¾… 2 ä¸ªç»­å­—èŠ‚â€çš„çŠ¶æ€ã€‚
   - ç ç‚¹ç´¯ç§¯ï¼š`codep = (0xFF >> 3) & 0xE4 = 0x1F & 0xE4 = 0x04` (èµ·å§‹æœ‰æ•ˆä½ 1110xxxx ä¸­çš„ `0100`) ã€‚

2) è¯» `0xB8`ï¼šç±»å‹ä¸º 7 (A0..BF çš„ç»­å­—èŠ‚å­ç±») ã€‚
   - çŠ¶æ€ï¼šä»â€œæœŸå¾… 2 ä¸ªç»­å­—èŠ‚â€è½¬åˆ°â€œæœŸå¾… 1 ä¸ªç»­å­—èŠ‚â€ã€‚
   - ç ç‚¹ç´¯ç§¯ï¼š`codep = (0x04 << 6) | (0xB8 & 0x3F) = 0x100 | 0x38 = 0x138`ã€‚

3) è¯» `0x96`ï¼šç±»å‹ä¸º 9 (90..9F çš„ç»­å­—èŠ‚å­ç±») ã€‚
   - çŠ¶æ€ï¼šä»â€œæœŸå¾… 1 ä¸ªç»­å­—èŠ‚â€å›åˆ° `ACCEPT` (å®Œæˆ) ã€‚
   - ç ç‚¹ç´¯ç§¯ï¼š`codep = (0x138 << 6) | (0x96 & 0x3F) = 0x4E16`ï¼Œå³ U+4E16ã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåˆæ³•æ€§ (æ¯æ­¥éƒ½æŸ¥äº†"çŠ¶æ€ Ã— ç±»å‹") ä¸æ•°å€¼ç´¯ç§¯ (ä½è¿ç®—) åŒæ—¶å®Œæˆï¼Œä¸­é€”ä»»ä¸€æ­¥ä¸ç¬¦åˆ (ä¾‹å¦‚ E0 åç¬¬äºŒä¸ªå­—èŠ‚è½åœ¨ 80..9F) éƒ½ä¼šç›´æ¥èµ°åˆ° `REJECT`ã€‚

### ä¾‹å­ 2ï¼š`F0 9F 98 80` (U+1F600ï¼ŒğŸ˜€) 

æ­¥éª¤ï¼š
1) è¯» `0xF0`ï¼šç±»å‹ 11 (å››å­—èŠ‚èµ·å§‹ä¸­"ç¬¬äºŒå­—èŠ‚å—é™ä¸º 90..BF"çš„ç‰¹åŒ–) ã€‚
   - çŠ¶æ€ï¼šä» `ACCEPT` è¿›å…¥"å››å­—èŠ‚èµ·å§‹åçš„ç¬¬ 1 é˜¶æ®µ"ã€‚
   - ç ç‚¹ç´¯ç§¯ï¼š`codep = (0xFF >> 11) & 0xF0 = 0 & 0xF0 = 0x00`ã€‚
   - æ³¨ï¼š`0xFF >> 11 = 0`ï¼ŒF0 å­—èŠ‚ä½œä¸º 4 å­—èŠ‚åºåˆ—èµ·å§‹ï¼Œå…¶æœ‰æ•ˆè½½è·ä¸º 0ã€‚

2) è¯» `0x9F`ï¼šç±»å‹ 9 (90..9F) ã€‚
   - çŠ¶æ€ï¼šæ»¡è¶³ F0 çš„é™åˆ¶ï¼Œä»ç¬¬ 1 é˜¶æ®µ -> ç¬¬ 2 é˜¶æ®µã€‚
   - ç ç‚¹ç´¯ç§¯ï¼š`codep = (0x00 << 6) | (0x9F & 0x3F) = 0x1F`ã€‚

3) è¯» `0x98`ï¼šç±»å‹ 9 (90..9F) ã€‚
   - çŠ¶æ€ï¼šç¬¬ 2 é˜¶æ®µ -> ç¬¬ 3 é˜¶æ®µã€‚
   - ç ç‚¹ç´¯ç§¯ï¼š`codep = (0x1F << 6) | (0x98 & 0x3F) = 0x7D8`ã€‚

4) è¯» `0x80`ï¼šç±»å‹ 1 (80..8F) ã€‚
   - çŠ¶æ€ï¼šç¬¬ 3 é˜¶æ®µ -> `ACCEPT`ã€‚
   - ç ç‚¹ç´¯ç§¯ï¼š`codep = (0x7D8 << 6) | (0x80 & 0x3F) = 0x1F600`ã€‚

å¦‚æœç¬¬ 2 æ­¥æŠŠ `0x9F` æ¢æˆ `0x8F` (å³ F0 8F 98 80) ï¼Œä¼šå›  "F0 çš„ç¬¬äºŒå­—èŠ‚å¿…é¡» â‰¥ 0x90 "è€Œåœ¨çŠ¶æ€è¡¨é‡Œç›´æ¥èµ°å‘ `REJECT`ï¼Œè¿™å°±æ˜¯â€œé˜²è¿‡é•¿ç¼–ç â€çš„æŸ¥è¡¨ä½“ç°ã€‚

### ä¾‹å­ 3ï¼š`ED A0 80` (ç¦æ­¢ä»£ç†åŒºé—´ç¤ºä¾‹ï¼Œå¿…é¡» REJECT) 

1) `0xED`ï¼šç±»å‹ 4 (ED ç‰¹åŒ–ï¼Œç”¨ä»¥é™åˆ¶ç¬¬äºŒå­—èŠ‚) ã€‚
2) `0xA0`ï¼šç±»å‹ 7 (A0..BF) ã€‚
- åœ¨è¡¨ä¸­ï¼Œ`(çŠ¶æ€_after_ED, ç±»å‹=7)` ä¼šè¿›å…¥ `REJECT`ï¼Œå› ä¸º ED ä¹‹åä¸èƒ½è·Ÿ A0..BF (è¿™æ°å¥½å¯¹åº” UTF-16 ä»£ç†åŒºé—´çš„ç¼–ç èŒƒå›´) ã€‚



## ä»£ç 

åŠ äº†ä¸€ç‚¹è°ƒè¯•ä¿¡æ¯

```c
#include <stdint.h>
#include <stdio.h>

#define UTF8_ACCEPT 0
#define UTF8_REJECT 12

// Copyright (c) 2008-2009 Bjoern Hoehrmann <bjoern@hoehrmann.de>
// See https://bjoern.hoehrmann.de/utf-8/decoder/dfa/ for details.
static const uint8_t utf8d[] = {
  // The first part of the table maps bytes to character classes that
  // to reduce the size of the transition table and create bitmasks.
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,  9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,
  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
  8,8,2,2,2,2,2,2,2,2,2,2,2,2,2,2,  2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
  0,3,3,3,3,3,3,3,3,3,3,3,3,4,3,3, 11,6,6,6,5,8,8,8,8,8,8,8,8,8,8,8,

  // The second part is a transition table that maps a combination
  // of a state of the automaton and a character class to a state.
   0,12,24,36,60,96,84,12,12,12,48,72, 12,12,12,12,12,12,12,12,12,12,12,12,
  12, 0,12,12,12,12,12, 0,12, 0,12,12, 12,24,12,12,12,12,12,24,12,24,12,12,
  12,12,12,12,12,12,12,24,12,12,12,12, 12,24,12,12,12,12,12,12,12,24,12,12,
  12,12,12,12,12,12,12,36,12,36,12,12, 12,36,12,12,12,12,12,36,12,36,12,12,
  12,36,12,12,12,12,12,12,12,12,12,12,
};

static inline uint32_t decode(uint32_t* state, uint32_t* codep, uint32_t byte)
{
    uint32_t type = utf8d[byte];

    *codep = (*state != UTF8_ACCEPT) ? (byte & 0x3fu) | (*codep << 6) : (0xff >> type) & (byte);

    *state = utf8d[256 + *state + type];
    return *state;
}

static void decode_and_trace(const uint8_t* s)
{
    uint32_t state = UTF8_ACCEPT;
    uint32_t codepoint = 0;
    size_t i = 0;

    printf("Input bytes (hex):\n");
    for (const uint8_t* p = s; *p; ++p) {
        printf("%02X ", *p);
    }
    printf("\\0\n\n");

    for (const uint8_t* p = s; *p; ++p, ++i) {
        uint32_t prev_state = state;
        uint32_t byte = *p;
        uint32_t type = utf8d[byte];

        (void)type;

        (void)decode(&state, &codepoint, byte);

        printf("[%02zu] byte=0x%02X type=%u prev_state=%u new_state=%u codep=0x%08X\n",
            i, byte, type, prev_state, state, codepoint);

        if (state == UTF8_ACCEPT) {
            printf("  -> ACCEPT codepoint U+%04X\n", codepoint);
        } else if (state == UTF8_REJECT) {
            printf("  -> REJECT (invalid sequence). Emit U+FFFD and reset.\n");
            state = UTF8_ACCEPT;
            codepoint = 0;
        }
    }

    if (state != UTF8_ACCEPT) {
        printf("(end) Incomplete sequence. Emit U+FFFD.\n");
    }
}

int main(void)
{
    static const char* string_0= "Hello, ä¸–ç•Œ! ";
    static const char* string_1 = "\xF0\x9F\x98\x80"; // U+1F600 ğŸ˜€
    static const char* string_2 = " BAD:\xC0\xAF"; // overlong '/'
    static const char* string_3 = "ä¸–";
    static const char* string_4 = "í€";  // ED 81 80

    const uint8_t *input = (const uint8_t *)string_3;

    printf("UTF-8 DFA decode trace\n");
    printf("Decoding string literal: %s\n\n", (const char*)input);

    decode_and_trace(input);

    (void)string_0;
    (void)string_1;
    (void)string_2;
    (void)string_3;
    (void)string_4;

    return 0;
}
```
